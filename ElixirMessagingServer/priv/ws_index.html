<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <title>Websocket client</title>

    <script src="./static/jquery.min.js"></script>
    <script src="./static/Long.min.js"></script>         <!-- https://raw.github.com/dcodeIO/Long.js/master/dist/Long.min.js -->
    <script src="./static/ByteBufferAB.min.js"></script> <!-- https://raw.github.com/dcodeIO/ByteBuffer.js/master/dist/ByteBufferAB.min.js -->
    <script src="./static/ProtoBuf.js"></script>     <!-- https://raw.github.com/dcodeIO/ProtoBuf.js/master/dist/ProtoBuf.min.js -->
    <script type="text/javascript">
      if (typeof dcodeIO === 'undefined' || !dcodeIO.ProtoBuf) {
        throw(new Error("ProtoBuf.js is not present. Please see www/index.html for manual setup instructions."));
      }

      // Initialize ProtoBuf.js
      var websocket;
      var ProtoBuf = dcodeIO.ProtoBuf;
      var LoginMessage = ProtoBuf.loadProtoFile("./static/CommsMessages.proto").build("Login");
      var SayMessage = ProtoBuf.loadProtoFile("./static/CommsMessages.proto").build("Say");
      var HeaderMessage = ProtoBuf.loadProtoFile("./static/CommsMessages.proto").build("Header");

      $(document).ready(init);
      
      function init() {
          $('#server').val("ws://" + window.location.hostname + ":8081/");
          if(!("WebSocket" in window)){  
              $('#status').append('<p><span style="color: red;">websockets are not supported</span></p>');
              $("#navigation").hide();  
          } else {
              $('#status').append('<p><span style="color: green;">websockets are supported</span></p>');
              connect();
          };
              $("#connected").hide(); 	
              $("#content").hide(); 	
      };

      function connect()
      {
          wsHost = $("#server").val();
          websocket = new WebSocket(wsHost);
          websocket.binaryType = "blob";//"arrayBuffer";
          showScreen('<b>Connecting to: ' +  wsHost + '</b>'); 
          websocket.onopen = function(evt) { onOpen(evt) }; 
          websocket.onclose = function(evt) { onClose(evt) }; 
          websocket.onmessage = function(evt) { onMessage(evt) }; 
          websocket.onerror = function(evt) { onError(evt) }; 
      };  
      
      function disconnect() {
          websocket.close();
      }; 

      function toggle_connection(){
          if(websocket.readyState == websocket.OPEN){
              disconnect();
          } else {
              connect();
          };
      };

      function appendBuffer( buffer1, buffer2 ) {
        var tmp = new Uint8Array( buffer1.byteLength + buffer2.byteLength );
        tmp.set( new Uint8Array( buffer1 ), 0 );
        tmp.set( new Uint8Array( buffer2 ), buffer1.byteLength );
        return tmp.buffer;
      }

      function login() {
          if(websocket.readyState == websocket.OPEN){
              usertxt = $("#user_txt").val();
              passtxt = $("#pass_txt").val();
              var header = new HeaderMessage();
              header.msgtype = 5;
              header.from = usertxt;
              header.dest = "";
              var headerBuf = header.encodeAB();
              var login = new LoginMessage();
              login.username = usertxt;
              login.password = passtxt;
              var loginBuf = login.encodeAB();
              var lengthBuf = new Int8Array(1);
              lengthBuf[0] = headerBuf.byteLength;
              var sendBuf = appendBuffer(appendBuffer(lengthBuf, headerBuf), loginBuf);
              var int8SendBuf = new Int8Array(sendBuf);
              websocket.send(int8SendBuf);

              showScreen('sending: Login');
          } else {
               showScreen('websocket is not connected');
          };
      };

      function sendTxt() {
          if(websocket.readyState == websocket.OPEN){
              usertxt = $("#user_txt").val();
              txt = $("#send_txt").val();
              var header = new HeaderMessage();
              header.msgtype = 6;
              header.from = usertxt;
              header.dest = "";
              var headerBuf = header.encodeAB();
              var say = new SayMessage();
              say.text = txt;
              var sayBuf = say.encodeAB();
              var lengthBuf = new Int8Array(1);
              lengthBuf[0] = headerBuf.byteLength;
              var sendBuf = appendBuffer(appendBuffer(lengthBuf, headerBuf), sayBuf);
              var int8SendBuf = new Int8Array(sendBuf);
              websocket.send(int8SendBuf);
              showScreen('sending: ' + txt); 
          } else {
               showScreen('websocket is not connected'); 
          };
      };

      function onOpen(evt) { 
          showScreen('<span style="color: green;">CONNECTED </span>'); 
          $("#connected").fadeIn('slow');
          $("#content").fadeIn('slow');
      };  

      function onClose(evt) { 
          showScreen('<span style="color: red;">DISCONNECTED </span>');
      };  

      function onMessage(evt) { 
          showScreen('<span style="color: blue;">RESPONSE: ' + evt.data+ '</span>'); 
      };  

      function onError(evt) {
          showScreen('<span style="color: red;">ERROR: ' + evt.data+ '</span>');
      };

      function showScreen(txt) { 
          $('#output').prepend('<p>' + txt + '</p>');
      };

      function clearScreen() 
      { 
          $('#output').html("");
      };
    </script>
  </head>

  <body>
    <div id="header">
      <h1>Websocket client</h1>
      <div id="status"></div>
    </div>


    <div id="navigation">

      <p id="connecting">
	<input type='text' id="server" value=""></input>
	<button type="button" onclick="toggle_connection()">connection</button>
      </p>
      <div id="user">
	<p>
	  <input type='text' id="user_txt" value=></input>
	  <input type='text' id="pass_txt" value=></input>
	  <button type="button" onclick="login();">login</button>
	</p>
      </div>
      <div id="connected">				
	<p>
	  <input type='text' id="send_txt" value=></input>
	  <button type="button" onclick="sendTxt();">send</button>
	</p>
      </div>

      <div id="content">						
	<button id="clear" onclick="clearScreen()" >Clear text</button>
	<div id="output"></div>
      </div>

    </div>
  </body>
</html> 
